#cloud-config
system_info:
  default_user:
    name: stanuser
#     lock_passd: false
#    ssh-authorized-keys:
#      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDTZw4TKc3uohUlQpCJ467m2mZvdQ8XyQ/B7sxxcB8krXRdw+r0AEB1MMHAndpafS5Ya33oO4fzSxgbAyYWxJ8qVpnNu2/qI0CByk41KR4D7teZOLheOPKBMW0OASFAZcFnGI6Rp9yqwip2g4Xvf8596mN+cx+L4dbd13Ex+6aDqP7gsT1tPkj/514pLl5CBkE+s/R/Ok8FOnANIIHYoLtYZna8OQsnvi6nFa5U0o5AxtACm/GsvmzEGi39c0uSLUsanK+4avGdFVNpGTgnjgvM1lFLSvyapIZCHcGm9f9Q7Qk5Mesip8qvhS8SQcV1Uh2cXziRz6zsB+fcqdUAr1zx

password: $6$rounds=4096$1EQ9n0RZP8LOJX$H/FxoaL904hbgAGTfvVqVcoiJzaCkVSoeRzIq1UXKMtw.Ofm8JPuvEIntx1pVBU6rwri1kT0Sk7I0Vduvlg6n1
chpasswd: { expire: False }
hostname: myjammy

# configure sshd to disallow users logging in using password 
# rather than just keys
# local terminal login works if set false
ssh_pwauth: false

package_upgrade: false

# Install additional packages on first boot
#
# Default: none
#
# if packages are specified, then package_update will be set to true
#
# packages may be supplied as a single package name or as a list
# with the format [<package>, <version>] wherein the specific
# package version will be installed.

packages:
   - net-tools
   - inxi
#   - fail2ban
  # - xfce4
  # - xfce4-session
  # - xrdp
   - make
   - g++
  # - firefox
   - libssl-dev # rstudio dep
   - libcurl4-openssl-dev 
  # - unixodbc-dev
  # - libxml2-dev 
  # - libmariadb-dev 
  # - libfontconfig1-dev 
  # - libharfbuzz-dev
  # - libfribidi-dev 
  # - libfreetype6-dev 
  # - libpng-dev 
  # - libtiff5-dev 
  # - libjpeg-dev


write_files:
  # this runs as root before users/ groups are created!
  - path: /post_install.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      sudo sed -i -e '/allow_channels=/ s/=.*/=false/' /etc/xrdp/xrdp.ini
      #sudo rmdir /home/stanuser/thinclient_drives
      sudo systemctl enable xrdp
      sudo adduser xrdp ssl-cert
      echo xfce4-session > /home/stanuser/.xsession
      sudo service xrdp restart
  - path: /install_r.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      sudo apt-get install -y --no-install-recommends software-properties-common dirmngr
      wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
      sudo add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
      sudo apt-get install -y --no-install-recommends r-base
      #sudo Rscript -e "install.packages('tidyverse')"
      sudo Rscript -e "install.packages('gapminder')"
      sudo Rscript -e "remotes::install_github(standev/cmdstanr); cmdstanr::install_stan()"
  - path: /install_rstudio.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      cd $HOME
      mkdir Downloads
      cd Downloads
      #RSTUDIO_FILE=rstudio-2023.09.1-494-amd64.deb
      #wget -q https://download1.rstudio.org/electron/focal/amd64/$RSTUDIO_FILE
      RSTUDIO_FILE=rstudio-2022.07.4-587-amd64.deb
      wget -q https://s3.amazonaws.com/rstudio-ide-build/desktop/jammy/amd64/$RSTUDIO_FILE
      sudo apt-get -y install gdebi-core 
      sudo gdebi -n $RSTUDIO_FILE
      
runcmd:
  # this runs as root in the final stage
  #- [bash, /post_install.sh ]
  #- [bash, /install_r.sh ]
  - [bash, /install_rstudio.sh ]
